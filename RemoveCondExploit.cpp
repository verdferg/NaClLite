#include "RemoveCondExploit.h"

RemoveCondExploits gCond;

void RemoveCondExploits::Run(CBaseEntity* pLocal, CUserCmd* pCommand)
{
	if (!gCvars.removecond_enabled)
		return;

	if (Util->IsKeyPressed(gCvars.removecond_key) //G
												  //  && pLocal->GetLifeState() == LIFE_ALIVE
		&& !gInts.Engine->Con_IsVisible()
		&& gInts.Engine->IsConnected())
		RemoveConds(pLocal, pCommand, (int)gCvars.removecond_value);

	if (gCvars.removecond_onattack && !gInts.Engine->Con_IsVisible() && gInts.Engine->IsConnected()) //Main code by Castle & bencat //Fixed by wasky (was broken)
	{
		/*if (pLocal->szGetClass() != "Demoman")
			return;

		CBaseCombatWeapon *wep = pLocal->GetActiveWeapon();
		if (!wep)
			return;

		if (!wep->GetSlot() == 1)
			return; <-- Weapon Check For If You Want To Only Do It With The Sticky Launcher/Use As Sticky Spam*/

		if (pLocal->GetLifeState() != LIFE_ALIVE)
			return;

		static bool bSwitch = false;
		if ((pCommand->buttons & IN_ATTACK) && !bSwitch)
		{
			bSwitch = true;
		}
		else if (bSwitch)
		{
			RemoveConds(pLocal, pCommand, 50); //This value is best for sticky spamming, 66 is another good value but I'll just keep 50 for now.
			pCommand->buttons &= ~IN_ATTACK;
			bSwitch = false;
		}
	}
}
void RemoveCondExploits::RemoveConds(CBaseEntity * local, CUserCmd * cmd, int value, bool disableattack)
{
	if (local == NULL) return;

	if (local->GetLifeState() != LIFE_ALIVE) return;

	INetChannel* ch = (INetChannel*)gInts.Engine->GetNetChannelInfo();
	int& m_nOutSequenceNr = *(int*)((unsigned)ch + 8);
	m_nOutSequenceNr += value;
}

void RemoveCondExploits::RemoveConds(CBaseEntity *local, int value)
{
	RemoveConds(local, new CUserCmd(), value);
}